name: CI
on: [push, pull_request]

jobs:
  run:
    runs-on: ${{ matrix.operating-system }}
    services:
      mysql:
        image: mysql:5.7.27
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
        - 3306
    strategy:
      max-parallel: 15
      fail-fast: false
      matrix:
        operating-system: [ubuntu-latest]
        php-versions: ['7.1', '7.2', '7.3']
        shopware-versions: ['5.6', '5.5', '5.4']
    steps:
    - name: Checkout
      uses: actions/checkout@master
    - name: Install PHP
      uses: shivammathur/setup-php@master
      with:
        php-version: ${{ matrix.php-versions }}
        extensions: mbstring, xdebug
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8
    - name: Check PHP Version
      run: php -v
    - name: PHP Syntax Checker
      run: find . -type f -name '*.php' -print0 | xargs -0 -n1 -P4 php -l -n | (! grep -v "No syntax errors detected" )
    - name: Install Shopware and Plugin
      run: |
        git clone --depth=1 -b $SWVER https://github.com/shopware/shopware.git /tmp/shopware
        cd /tmp/shopware
        ant -f build/build.xml -Ddb.user=root -Ddb.password=root -Ddb.host=127.0.0.1 -Ddb.name=shopware build-unit
        cp -R $GITHUB_WORKSPACE/Frontend/MoptPaymentPayone /tmp/shopware/engine/Shopware/Plugins/Default/Frontend
        cd /tmp/shopware
        ls engine/Shopware/Plugins/Default/Frontend
        php bin/console sw:plugin:refresh
        php bin/console sw:plugin:list
        php bin/console sw:plugin:install MoptPaymentPayone
        php bin/console sw:plugin:activate MoptPaymentPayone
        php bin/console sw:generate:attributes
        php bin/console orm:generate:proxies

